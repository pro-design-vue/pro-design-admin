import{g as D,f as X,j as k,r as h,h as $,R as N,i as H,F as J,d as Q,p as Z}from"./index-CEX7zxrm.js";import{u as G,D as ee,C as te,a as oe}from"./FormListContext-D42iwcCA.js";import{F as ae,a as le}from"./FormTitle-DCDPji8S.js";import{u as ne}from"./useFieldValue-CvZJ1-Rf.js";import{S as K}from"./index-C5d8sp_s.js";import{c as I,aE as ie,a1 as re,aG as ue}from"./basic-B4_U5Jym.js";import{d as V,a3 as C,a0 as f,M as i,a5 as de,j as ce,ba as q,X as se}from"./index-Bg643ARb.js";import{T as E}from"./collapseMotion-CHI8RJn1.js";import{F as z}from"./index-C-ZB4OH6.js";import{i as ve}from"./isEqual-DLw9SpKa.js";import{c as me}from"./index-C-uu4u6f.js";import"./index-PlkZAFuf.js";import"./index-syUDFwVA.js";import"./index-Bw3mB0Mb.js";import"./RightOutlined-BtSfGi4K.js";import"./pick-RwQtdPfR.js";import"./hasIn-B4h2Teaf.js";import"./index-H4MxIDlP.js";import"./Col-CZ83tv3K.js";import"./index-CixbE7dA.js";import"./useBreakpoint-3qsTtJLt.js";import"./FormItemContext-BDfaEFBq.js";import"./isMobile--2fOlCHx.js";const fe=["formSet","divider"];var ye=V({name:"FormListItem",inheritAttrs:!1,props:{index:{type:Number,default:0},originName:{type:[String,Array],default:()=>[]},fieldKey:{type:Number,default:0},items:{type:Array,default:()=>[]},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},copyIconProps:{type:[Object,Boolean],default:void 0},deleteIconProps:{type:[Object,Boolean],default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},count:{type:Number,default:0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},record:{type:Object,default:void 0},action:{type:Object,required:!0},onRemove:{type:Function,required:!0},onCopy:{type:Function,required:!0}},emits:["remove","copy"],setup(e,{slots:P}){const{formatItems:w,prefixCls:c,formData:A,grid:u}=D(),b=G(),_=X(),p=C(!1),v=C(!1),y=f(()=>e.index),F=f(()=>{var l;return[(l=b.listName)==null?void 0:l.value,e.originName,y.value].filter(o=>o!==void 0).flat(1)}),j=f(()=>[b.listKey,k(e.originName),e.fieldKey].filter(l=>l!==void 0).flat(1).join("_")),S=l=>{var o;const n=[];return(o=l.dependencies)==null||o.forEach(r=>{const s=k(r);s&&n.push([...F.value,s].filter(O=>O!==void 0).flat(1))}),n},B=l=>I(l).filter(o=>{var n;return!fe.includes((n=o.fieldType)!=null?n:"")}).map(o=>{var n,r,s,O,x,T;if(o.fieldType===Q.GROUP)return o.children=B((r=h((n=o.children)!=null?n:[],A.value))!=null?r:[]),o;const M=(s=o.originName)!=null?s:o.name,W=(O=o.originKey)!=null?O:o.key,R=k(o.name),U=y.value===0||e.alwaysShowItemLabel?o.title:void 0,L={...o,title:U,originKey:W,key:`${j.value}_${(x=o.key)!=null?x:R?.join("_")}`,originName:M,name:[...(T=F?.value)!=null?T:[],R].filter(Y=>Y!==void 0).flat(1)};return Array.isArray(o.dependencies)&&o.dependencies.length>0&&o.name&&(L.dependencies=S(L)),L}),t=f(()=>{var l,o,n;const r=(o=h((l=e.items)!=null?l:[],A.value))!=null?o:[];return(n=w?.(B(r)))!=null?n:[]}),a=f(()=>{var l;if(e.readonly||e.deleteIconProps===!1||e.min===e.count)return null;const{icon:o,tooltipText:n}=(l=e.deleteIconProps)!=null?l:{};let r=i(ee,null,null);if(o){const s=$(o,_);r=i(N,{vnode:s,props:{defaultDom:r}},null)}return i(K,{size:"small",spinning:p.value},{default:()=>[i(E,{title:n??"删除此行",key:"delete"},{default:()=>[i("div",{class:`${c}-list-action-icon ${c}-list-action-remove`,onClick:d},[r])]})]})}),m=f(()=>{var l;if(e.readonly||e.copyIconProps===!1||e.max===e.count)return null;const{icon:o,tooltipText:n}=(l=e.copyIconProps)!=null?l:{};let r=i(te,null,null);if(o){const s=$(o,_);r=i(N,{vnode:s,props:{defaultDom:r}},null)}return i(K,{size:"small",spinning:v.value},{default:()=>[i(E,{title:n??"复制此行",key:"copy"},{default:()=>[i("div",{class:`${c}-list-action-icon ${c}-list-action-copy`,onClick:g},[r])]})]})}),d=async()=>{p.value=!0,await e.onRemove(y.value),p.value=!1},g=async()=>{v.value=!0,await e.onCopy(y.value),v.value=!1};return oe({isList:!0,originName:e.originName,index:y,fieldKey:e.fieldKey,listName:F,listKey:j.value,rowData:f(()=>e.record)}),()=>{var l,o;if(!t.value.length)return null;const n=i("div",{class:`${c}-list-action`},[m.value,a.value]),r=P.action?i(N,{vnode:P.action,props:{index:y.value,action:e.action,defaultDom:n,record:(l=e.record)!=null?l:{}}},null):n,s=i("div",{class:`${c}-list-item-container`,style:{width:u?.value?"100%":void 0}},[i(H,{rowProps:e.rowProps},{default:()=>[i(J,{list:t.value},null)]})]);return P.item?i(N,{vnode:P.item,props:{listDom:s,actionDom:r,record:(o=e.record)!=null?o:{}}},null):i("div",{class:`${c}-list-item`,style:"display: flex; align-items: flex-end;"},[s,r])}}});function be(e){return typeof e=="function"||Object.prototype.toString.call(e)==="[object Object]"&&!se(e)}var ge=V({name:"FormListContainer",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},readonly:{type:Boolean,default:void 0},rowProps:{type:Object,default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:P}){const w=C(!1),c=C([]),{prefixCls:A}=D(),u=de({keys:[],id:0}),{fieldValue:b,onValueChange:_}=ne({namePath:f(()=>e.name),initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform}),p=z.useInjectFormItemContext(),v=f(()=>{var t,a;return(a=(t=b.value)==null?void 0:t.length)!=null?a:0}),y={add:async(t,a)=>{var m,d,g;if((m=e.actionGuard)!=null&&m.beforeAddRow&&!await((d=e.actionGuard)==null?void 0:d.beforeAddRow(t,a,v.value)))return!1;const l=I((g=b.value)!=null?g:[]);return a!==void 0&&a>=0&&a<=l.length?(u.value.keys=[...u.value.keys.slice(0,a),u.value.id,...u.value.keys.slice(a)],_(I([...l.slice(0,a),t,...l.slice(a)])),p.onFieldChange()):(u.value.keys=[...u.value.keys,u.value.id],_(I([...l,t])),p.onFieldChange()),u.value.id+=1,Promise.resolve().then(()=>{var o;(o=e.onAfterAdd)==null||o.call(e,t,a,v.value)}),!0},remove:async t=>{var a,m,d;if((a=e.actionGuard)!=null&&a.beforeRemoveRow&&!await((m=e.actionGuard)==null?void 0:m.beforeRemoveRow(t,v.value)))return!1;const g=I((d=b.value)!=null?d:[]),l=new Set(Array.isArray(t)?t:[t]);if(l.size<=0)return!1;u.value.keys=u.value.keys.filter((n,r)=>!l.has(r));const o=g.filter((n,r)=>!l.has(r));return _(o),p.onFieldChange(),Promise.resolve().then(()=>{var n;(n=e.onAfterRemove)==null||n.call(e,t,v.value)}),!0}},F=async()=>{var t;if(e.creatorButtonProps!==!1){w.value=!0;let a=v.value;((t=e.creatorButtonProps)==null?void 0:t.position)==="top"&&(a=0),await y.add(I(h(e.creatorRecord)||{}),a),w.value=!1}},j=async t=>{await y.remove(t)},S=async t=>{await y.add(I(b.value[t]),v.value+1)};ce(b,()=>{var t;ve(c.value,b.value)||(c.value=I((t=b.value)!=null?t:[]))},{immediate:!0});const B=f(()=>{var t,a;if(e.readonly||e.creatorButtonProps===!1||v.value===e.max)return null;const{position:m="bottom",creatorButtonText:d="添加一行数据"}=(t=e.creatorButtonProps)!=null?t:{},{block:g=!0,type:l="dashed",...o}=ie((a=e.creatorButtonProps)!=null?a:{},["position","creatorButtonText"]),n=i(re,q({class:`${A}-list-creator-button-${m}`,type:l,block:g,icon:i(me,null,null)},o,{loading:w.value,onClick:F}),be(d)?d:{default:()=>[d]});return P.creator?i(N,{vnode:P.creator,props:{defaultDom:n,add:y.add,count:v.value}},null):n});return()=>{var t,a,m,d,g,l,o;return e.readonly&&!((t=c.value)!=null&&t.length)&&(c.value=[{}]),i("div",{style:"width: max-content; max-width: 100%; min-width: 100%; ",class:{[`${A}-list-container`]:!0,[`${A}-list-empty`]:((m=(a=b.value)!=null?a:[])==null?void 0:m.length)==0}},[e.creatorButtonProps!==!1&&((d=e.creatorButtonProps)==null?void 0:d.position)==="top"&&B.value,((g=c.value)!=null?g:[]).map((n,r)=>{let s=u.value.keys[r];return s===void 0&&(u.value.keys[r]=u.value.id,s=u.value.keys[r],u.value.id+=1),i(ye,{key:s,fieldKey:s,originName:e.originName,index:r,items:e.items,rowProps:e.rowProps,min:e.min,max:e.max,count:v.value,record:n,alwaysShowItemLabel:e.alwaysShowItemLabel,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,action:y,readonly:e.readonly,onRemove:j,onCopy:S},{action:P.action,item:P.item})}),e.creatorButtonProps!==!1&&(((l=e.creatorButtonProps)==null?void 0:l.position)==="bottom"||((o=e.creatorButtonProps)==null?void 0:o.position)===void 0)&&B.value])}}});const Pe=["autoLink","colon","hasFeedback","labelAlign","labelCol","required","validateFirst","validateStatus","validateTrigger","wrapperCol","required"];var Ge=V({name:"FormList",inheritAttrs:!1,props:{name:{type:[String,Array],default:void 0},originName:{type:[String,Array],default:void 0},initialValue:{type:Object,default:void 0},title:{type:[String,Object,Function],default:void 0},tooltip:{type:[String,Boolean],default:void 0},colProps:{type:Object,default:void 0},rowProps:{type:Object,default:void 0},formItemProps:{type:[Object,Function],default:void 0},convertValue:{type:Function,default:void 0},transform:{type:Function,default:void 0},readonly:{type:Boolean,default:void 0},items:{type:[Array,Function],default:void 0},min:{type:Number,default:void 0},max:{type:Number,default:void 0},alwaysShowItemLabel:{type:Boolean,default:void 0},creatorRecord:{type:[Object,Function],default:void 0},creatorButtonProps:{type:[Object,Boolean],default:void 0},rules:{type:[Object,Array,Function],default:void 0},copyIconProps:{type:[Object,String,Boolean],default:void 0},deleteIconProps:{type:[Object,String,Boolean],default:void 0},actionGuard:{type:Object,default:void 0},isValidateList:{type:Boolean,default:void 0},emptyListMessage:{type:String,default:"列表不能为空"},onAfterAdd:{type:Function,default:void 0},onAfterRemove:{type:Function,default:void 0}},emits:["after-add","after-remvoe"],setup(e,{slots:P}){const{formatItems:w,formData:c,prefixCls:A,readonly:u}=D(),b=G(),_=f(()=>{var t;return h((t=e.readonly)!=null?t:u?.value,c.value)}),p=f(()=>{var t;return((t=b.listName)==null?void 0:t.value)===void 0?[e.originName].flat(1):[b.listName.value,e.originName].flat(1)}),v=f(()=>{var t;return(t=h(e.formItemProps,c.value))!=null?t:{}}),y=f(()=>{var t;return ue({rules:_.value?[]:h((t=e.rules)!=null?t:v.value.rules,c.value),...Z(v.value,Pe)})}),F=f(()=>{var t,a;return(a=w?.(h((t=e.items)!=null?t:[],c.value)))!=null?a:[]}),j=f(()=>{const t={};return e.title&&(t.label=()=>i(ae,{title:e.title,tooltip:e.tooltip},null)),t}),S=(...t)=>{var a;(a=e.onAfterAdd)==null||a.call(e,...t)},B=(...t)=>{var a;(a=e.onAfterRemove)==null||a.call(e,...t)};return()=>{var t;if(!((t=e.name)!=null&&t.length)||!F.value.length)return null;const a=e.isValidateList?[{validator:(m,d)=>!d||d.length===0?Promise.reject(new Error(e.emptyListMessage)):Promise.resolve(),required:!0}]:h(e.rules,c.value);return i(le,{colProps:e.colProps},{default:()=>{var m,d;return[i("div",{class:`${A}-list`},[i(z.Item,q({required:_.value?!1:(d=(m=y.value)==null?void 0:m.rules)==null?void 0:d.some(g=>g.required),name:a?.length?p.value:void 0,rules:_.value?void 0:a},y.value),{default:()=>[i(ge,{name:e.name,originName:e.originName,title:e.title,tooltip:e.tooltip,rowProps:e.rowProps,initialValue:e.initialValue,convertValue:e.convertValue,transform:e.transform,items:F.value,min:e.min,max:e.max,readonly:_.value,alwaysShowItemLabel:e.alwaysShowItemLabel,creatorRecord:e.creatorRecord,creatorButtonProps:e.creatorButtonProps,copyIconProps:e.copyIconProps,deleteIconProps:e.deleteIconProps,actionGuard:e.actionGuard,onAfterAdd:S,onAfterRemove:B},{...P})],...j.value})])]}})}}});export{Ge as default};
